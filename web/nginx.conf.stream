stream {

    resolver 127.0.0.11 valid=30s;
    upstream intranet {
        server intranet:443;
#        server 192.168.1.113:444;
    }

    upstream default_https {
        server unix:/var/run/nginx.sock;
    }

    map $ssl_preread_server_name $upstream {
        default default_https;
        i.trajano.net intranet;
    }
    server {
        listen 443;
        ssl_preread on;

        proxy_pass $upstream;
        proxy_ssl_server_name on;
    }
}
